name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: latest
  # Placeholder Firebase config for emulator mode
  # checkov:skip=CKV_SECRET_6:Intentional placeholder values for Firebase emulator testing
  VITE_APIKEY: demo-test-key
  VITE_AUTH_DOMAIN: localhost
  VITE_PROJECT_ID: demo-natural-highs
  VITE_STORAGE_BUCKET: demo-natural-highs.appspot.com
  VITE_MESSAGING_SENDER_ID: "000000000000"
  VITE_APP_ID: demo-app-id
  VITE_USE_EMULATORS: "true"

jobs:
  # ============================================
  # Stage 1: Code Quality (Trunk.io)
  # ============================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Trunk
        uses: actions/cache@v4
        with:
          path: ~/.cache/trunk
          key: trunk-${{ runner.os }}-${{ hashFiles('.trunk/trunk.yaml') }}
          restore-keys: |
            trunk-${{ runner.os }}-

      - name: Trunk Check
        uses: trunk-io/trunk-action@v1
        with:
          post-annotations: false
          arguments: --ci

  # ============================================
  # Stage 2: Security Scanning
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk.sarif

      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('snyk.sarif') != ''
        with:
          sarif_file: snyk.sarif

  # ============================================
  # Stage 3: Unit Tests
  # ============================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests with coverage
        run: bun run test:ci -- --coverage

      - name: Coverage Threshold Check
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')

            echo "Line coverage: ${LINES}%"
            echo "Branch coverage: ${BRANCHES}%"
            echo "Function coverage: ${FUNCTIONS}%"
            echo "Statement coverage: ${STATEMENTS}%"

            FAILED=0

            # Threshold check (70% for all metrics - matches vitest.config.ts)
            # Using awk for portable float comparison
            if awk "BEGIN {exit !($LINES < 70)}"; then
              echo "::error::Line coverage ${LINES}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($BRANCHES < 70)}"; then
              echo "::error::Branch coverage ${BRANCHES}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($FUNCTIONS < 70)}"; then
              echo "::error::Function coverage ${FUNCTIONS}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($STATEMENTS < 70)}"; then
              echo "::error::Statement coverage ${STATEMENTS}% is below 70% threshold"
              FAILED=1
            fi

            if [ $FAILED -eq 1 ]; then
              exit 1
            fi

            echo "::notice::Coverage thresholds passed (70% for all metrics)"
          else
            echo "::warning::Coverage report not found"
          fi

      - name: Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json | jq -r '.total | "- Lines: \(.lines.pct)% (threshold: 70%)\n- Branches: \(.branches.pct)% (threshold: 70%)\n- Functions: \(.functions.pct)% (threshold: 70%)\n- Statements: \(.statements.pct)% (threshold: 70%)"' >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ============================================
  # Stage 4: E2E Tests (Sharded)
  # ============================================
  test-e2e:
    name: E2E Tests (Shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Java (for Firebase emulators)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps

      - name: Install Playwright system deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Auth emulator ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: bun run test:e2e:ci -- --shard=${{ matrix.shard }}/4
        env:
          CI: true

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # ============================================
  # Stage 5: Burn-In (Flaky Detection) - PRs Only
  # ============================================
  burn-in:
    name: Flaky Test Detection
    runs-on: ubuntu-latest
    needs: [test-e2e]
    if: github.event_name == 'pull_request'
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Java (for Firebase emulators)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install Playwright system deps
        run: bunx playwright install-deps

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Auth emulator ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Detect changed test files
        id: changed-tests
        run: |
          CHANGED_SPECS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(spec|test)\.(ts|js)$' || echo "")
          echo "specs=${CHANGED_SPECS}" >> $GITHUB_OUTPUT
          if [ -n "$CHANGED_SPECS" ]; then
            echo "## Changed Test Files" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGED_SPECS" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run burn-in loop (5 iterations)
        if: steps.changed-tests.outputs.specs != ''
        run: |
          echo "Running burn-in: 5 iterations on changed specs"
          SPECS="${{ steps.changed-tests.outputs.specs }}"
          for i in {1..5}; do
            echo "=========================================="
            echo "Burn-in iteration $i/5"
            echo "=========================================="
            bun run test:e2e:ci -- $SPECS || {
              echo "Burn-in failed on iteration $i"
              exit 1
            }
          done
          echo "All 5 burn-in iterations passed"
          echo "## Burn-In Result" >> $GITHUB_STEP_SUMMARY
          echo "All 5 iterations passed - tests are stable" >> $GITHUB_STEP_SUMMARY

      - name: Skip burn-in (no test changes)
        if: steps.changed-tests.outputs.specs == ''
        run: |
          echo "No test files changed, skipping burn-in"
          echo "## Burn-In Skipped" >> $GITHUB_STEP_SUMMARY
          echo "No test files changed in this PR" >> $GITHUB_STEP_SUMMARY

      - name: Upload burn-in artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # ============================================
  # Stage 6: Deploy Firestore Rules (main only)
  # ============================================
  deploy-firestore-rules:
    name: Deploy Firestore Rules
    runs-on: ubuntu-latest
    needs: [lint, security, test-unit, test-e2e]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: prd
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy Firestore Rules
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/sa.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.json

          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if firebase deploy --only firestore:rules --project naturalhighs; then
              echo "Deployment successful"
              break
            fi
            if [ $attempt -eq $max_attempts ]; then
              echo "All attempts failed"
              rm /tmp/sa.json
              exit 1
            fi
            echo "Attempt $attempt failed, retrying in $((attempt * 10)) seconds..."
            sleep $((attempt * 10))
            attempt=$((attempt + 1))
          done

          rm /tmp/sa.json
