name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: latest
  # Placeholder Firebase config for emulator mode
  # checkov:skip=CKV_SECRET_6:Intentional placeholder values for Firebase emulator testing
  VITE_APIKEY: demo-test-key
  VITE_AUTH_DOMAIN: localhost
  VITE_PROJECT_ID: demo-natural-highs
  VITE_STORAGE_BUCKET: demo-natural-highs.appspot.com
  VITE_MESSAGING_SENDER_ID: "000000000000"
  VITE_APP_ID: demo-app-id
  VITE_USE_EMULATORS: "true"

jobs:
  # ============================================
  # Stage 0: Detect Changes
  # ============================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    # Skip for release-please bot PRs (only version bumps)
    if: github.actor != 'natural-highs-bot[bot]'
    outputs:
      code: ${{ steps.filter.outputs.code }}
      code_files: ${{ steps.filter.outputs.code_files }}
      tests: ${{ steps.filter.outputs.tests }}
      tests_files: ${{ steps.filter.outputs.tests_files }}
      config: ${{ steps.filter.outputs.config }}
      ci: ${{ steps.filter.outputs.ci }}
      firestore: ${{ steps.filter.outputs.firestore }}
      any-code: ${{ steps.filter.outputs.code == 'true' || steps.filter.outputs.tests == 'true' || steps.filter.outputs.config == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Filter paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: shell
          filters: |
            code:
              - 'src/**'
              - '*.ts'
              - '*.js'
              - '*.mjs'
              - '*.cjs'
            tests:
              - 'tests/**'
              - '**/*.test.ts'
              - '**/*.test.tsx'
              - '**/*.spec.ts'
              - 'playwright.config.ts'
              - 'vitest.config.ts'
            config:
              - 'package.json'
              - 'bun.lock'
              - 'tsconfig*.json'
              - 'vite.config.ts'
              - 'tailwind.config.ts'
              - 'postcss.config.js'
            ci:
              - '.github/workflows/ci.yml'
              - '.trunk/**'
              - 'biome.json'
            firestore:
              - 'firestore.rules'
              - 'firebase.json'

      - name: Summarize changes
        run: |
          echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code | ${{ steps.filter.outputs.code }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.filter.outputs.tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config | ${{ steps.filter.outputs.config }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CI | ${{ steps.filter.outputs.ci }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Firestore | ${{ steps.filter.outputs.firestore }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 1: Code Quality (Trunk.io)
  # ============================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.any-code == 'true' || needs.detect-changes.outputs.ci == 'true'
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Trunk
        uses: actions/cache@v4
        with:
          path: ~/.cache/trunk
          key: trunk-${{ runner.os }}-${{ hashFiles('.trunk/trunk.yaml') }}
          restore-keys: |
            trunk-${{ runner.os }}-

      - name: Trunk Check
        uses: trunk-io/trunk-action@v1.2.4
        with:
          post-annotations: false
          arguments: --ci

  # ============================================
  # Stage 2: Unit Tests
  # ============================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.any-code == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-bun
        with:
          node-version: "22"

      - name: Run tests with coverage
        run: bun run test:ci -- --coverage
        env:
          CHANGED_FILES: ${{ needs.detect-changes.outputs.code_files }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./.build/test-results/junit.xml
          flags: unittests
          slug: Natural-Highs/live
          verbose: true
          codecov_yml_path: ./.github/codecov.yml

      - name: Coverage Threshold Check
        run: |
          if [ -f .build/coverage/coverage-summary.json ]; then
            LINES=$(cat .build/coverage/coverage-summary.json | jq -r '.total.lines.pct')
            BRANCHES=$(cat .build/coverage/coverage-summary.json | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat .build/coverage/coverage-summary.json | jq -r '.total.functions.pct')
            STATEMENTS=$(cat .build/coverage/coverage-summary.json | jq -r '.total.statements.pct')

            echo "Line coverage: ${LINES}%"
            echo "Branch coverage: ${BRANCHES}%"
            echo "Function coverage: ${FUNCTIONS}%"
            echo "Statement coverage: ${STATEMENTS}%"

            FAILED=0

            # Threshold check (70% for all metrics - matches vite.config.ts)
            # Using awk for portable float comparison
            if awk "BEGIN {exit !($LINES < 70)}"; then
              echo "::error::Line coverage ${LINES}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($BRANCHES < 70)}"; then
              echo "::error::Branch coverage ${BRANCHES}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($FUNCTIONS < 70)}"; then
              echo "::error::Function coverage ${FUNCTIONS}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($STATEMENTS < 70)}"; then
              echo "::error::Statement coverage ${STATEMENTS}% is below 70% threshold"
              FAILED=1
            fi

            if [ $FAILED -eq 1 ]; then
              exit 1
            fi

            echo "::notice::Coverage thresholds passed (70% for all metrics)"
          else
            echo "::warning::Coverage report not found"
          fi

      - name: Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f .build/coverage/coverage-summary.json ]; then
            cat .build/coverage/coverage-summary.json | jq -r '.total | "- Lines: \(.lines.pct)% (threshold: 70%)\n- Branches: \(.branches.pct)% (threshold: 70%)\n- Functions: \(.functions.pct)% (threshold: 70%)\n- Statements: \(.statements.pct)% (threshold: 70%)"' >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./.build/coverage/lcov.info
          flags: unittests
          slug: Natural-Highs/live
          name: unit-tests-${{ github.run_id }}
          fail_ci_if_error: false
          verbose: true
          codecov_yml_path: ./.github/codecov.yml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: .build/coverage/
          retention-days: 7

  # ============================================
  # Stage 3: E2E Tests (Sharded)
  # ============================================
  test-e2e:
    name: E2E Tests (Shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test-unit]
    # Run if code changed AND upstream jobs succeeded or were skipped (due to no changes)
    if: |
      always() &&
      needs.detect-changes.outputs.any-code == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped')
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-bun
        with:
          java-version: "21"
          install-playwright: "true"
          install-firebase: "true"

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Auth emulator ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: bun run test:e2e:ci -- --shard=${{ matrix.shard }}/4
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: .build/playwright-report/
          retention-days: 30

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: .build/test-results/
          retention-days: 30

  # ============================================
  # Stage 3b: Deploy E2E Test Report
  # ============================================
  deploy-test-report:
    name: Deploy Test Report
    runs-on: ubuntu-latest
    needs: [detect-changes, test-e2e]
    # Only deploy if E2E tests ran (not skipped) AND (on main OR tests failed)
    if: |
      always() &&
      needs.test-e2e.result != 'cancelled' &&
      needs.test-e2e.result != 'skipped' &&
      (github.ref == 'refs/heads/main' || needs.test-e2e.result == 'failure')
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Download all Playwright reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-shard-*
          path: all-reports
          merge-multiple: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Merge reports
        run: |
          # Merge all shard reports into one (bunx auto-installs playwright)
          bunx playwright merge-reports --reporter=html all-reports -o merged-report || {
            echo "Merge failed, using raw reports"
            mkdir -p merged-report
            cp -r all-reports/* merged-report/ 2>/dev/null || true
          }

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: merged-report
          production-deploy: ${{ github.ref == 'refs/heads/main' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "E2E Report - ${{ github.event.pull_request.title || github.sha }}"
          alias: ${{ github.event.pull_request.number && format('pr-{0}', github.event.pull_request.number) || '' }}
          enable-pull-request-comment: true
          enable-commit-comment: false
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: 033f172d-782e-430f-a338-b9dec48fff80
        timeout-minutes: 5

      - name: Add report link to summary
        run: |
          echo "## E2E Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the full test report with traces and screenshots:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[${{ steps.netlify.outputs.deploy-url }}](${{ steps.netlify.outputs.deploy-url }})" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 3c: Integration Tests (Real Emulators)
  # ============================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test-unit]
    # Run if code changed AND upstream jobs succeeded or were skipped
    if: |
      always() &&
      needs.detect-changes.outputs.any-code == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped')
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-bun
        with:
          java-version: "21"
          install-playwright: "true"
          install-firebase: "true"

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1 && curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "All emulators ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Run integration tests
        run: bun run test:integration:ci
        env:
          CI: true
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8080
          FIREBASE_AUTH_EMULATOR_HOST: 127.0.0.1:9099
          SESSION_SECRET: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            .build/playwright-report/
            .build/test-results/
          retention-days: 7

  # ============================================
  # Stage 4: Burn-In (Flaky Detection) - PRs Only
  # ============================================
  burn-in:
    name: Flaky Test Detection
    runs-on: ubuntu-latest
    needs: [detect-changes, test-e2e]
    # Run on PRs when tests changed AND E2E passed
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.tests == 'true' &&
      needs.test-e2e.result == 'success'
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup-bun
        with:
          java-version: "21"
          install-playwright: "true"
          install-firebase: "true"

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Auth emulator ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Run burn-in on changed tests
        run: |
          # Use tests_files from detect-changes instead of git diff
          CHANGED_SPECS="${{ needs.detect-changes.outputs.tests_files }}"
          if [ -z "$CHANGED_SPECS" ]; then
            echo "No test files in change detection, skipping burn-in"
            echo "## Burn-In Skipped" >> $GITHUB_STEP_SUMMARY
            echo "No test files detected in changes" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## Changed Test Files" >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_SPECS" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

          echo "Running burn-in: 5 iterations on changed specs"
          for i in {1..5}; do
            echo "=========================================="
            echo "Burn-in iteration $i/5"
            echo "=========================================="
            bun run test:e2e:ci -- $CHANGED_SPECS || {
              echo "Burn-in failed on iteration $i"
              exit 1
            }
          done
          echo "All 5 burn-in iterations passed"
          echo "## Burn-In Result" >> $GITHUB_STEP_SUMMARY
          echo "All 5 iterations passed - tests are stable" >> $GITHUB_STEP_SUMMARY

      - name: Upload burn-in artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            .build/test-results/
            .build/playwright-report/
          retention-days: 30

  # ============================================
  # Stage 5: Deploy Firestore Rules (main only)
  # ============================================
  deploy-firestore-rules:
    name: Deploy Firestore Rules
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test-unit, test-e2e]
    # Deploy only on main push when firestore rules changed AND tests passed/skipped
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.detect-changes.outputs.firestore == 'true' &&
      (needs.test-e2e.result == 'success' || needs.test-e2e.result == 'skipped')
    environment: prd
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Firebase CLI
        run: bun add -g firebase-tools

      - name: Deploy Firestore Rules
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/sa.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.json

          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if firebase deploy --only firestore:rules --project naturalhighs; then
              echo "Deployment successful"
              break
            fi
            if [ $attempt -eq $max_attempts ]; then
              echo "All attempts failed"
              rm /tmp/sa.json
              exit 1
            fi
            echo "Attempt $attempt failed, retrying in $((attempt * 10)) seconds..."
            sleep $((attempt * 10))
            attempt=$((attempt + 1))
          done

          rm /tmp/sa.json

  # ============================================
  # Stage 5b: Security Scanning
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.any-code == 'true' || needs.detect-changes.outputs.config == 'true'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@9adf32b1121593767fc3c057af55b55db032dc04  # pinned to master SHA
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=package.json --sarif-file-output=snyk.sarif

      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif
        continue-on-error: true

  # ============================================
  # Stage 5c: Bundle Analysis
  # ============================================
  bundle-analysis:
    name: Bundle Analysis
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test-unit]
    if: |
      always() &&
      needs.detect-changes.outputs.any-code == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-bun
        with:
          node-version: "22"

      - name: Build with bundle analysis
        run: bun run build
        env:
          VITE_USE_EMULATORS: "true"
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Stage 6: CI Summary
  # ============================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, test-unit, test-e2e, test-integration, deploy-test-report, burn-in, deploy-firestore-rules, security-scan, bundle-analysis]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Helper function to format status
          format_status() {
            case "$1" in
              success) echo "âœ… Passed" ;;
              failure) echo "âŒ Failed" ;;
              skipped) echo "â­ï¸ Skipped" ;;
              cancelled) echo "ðŸš« Cancelled" ;;
              *) echo "â“ $1" ;;
            esac
          }

          echo "| Detect Changes | $(format_status '${{ needs.detect-changes.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | $(format_status '${{ needs.lint.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $(format_status '${{ needs.test-unit.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | $(format_status '${{ needs.test-e2e.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | $(format_status '${{ needs.test-integration.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Report | $(format_status '${{ needs.deploy-test-report.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Flaky Detection | $(format_status '${{ needs.burn-in.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Firestore Deploy | $(format_status '${{ needs.deploy-firestore-rules.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | $(format_status '${{ needs.security-scan.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Analysis | $(format_status '${{ needs.bundle-analysis.result }}') |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test-unit.result }}" == "failure" ]] || \
             [[ "${{ needs.test-e2e.result }}" == "failure" ]]; then
            echo "### âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.detect-changes.result }}" == "skipped" ]]; then
            echo "### â­ï¸ Pipeline Skipped (release-please PR)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Pipeline Passed" >> $GITHUB_STEP_SUMMARY
          fi
