name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**/*.md"
      - docs/**
      - .vscode/**
  pull_request:
    branches: [main]
    paths-ignore:
      - "**/*.md"
      - docs/**
      - .vscode/**
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: latest
  # Placeholder Firebase config for emulator mode
  # checkov:skip=CKV_SECRET_6:Intentional placeholder values for Firebase emulator testing
  VITE_APIKEY: demo-test-key
  VITE_AUTH_DOMAIN: localhost
  VITE_PROJECT_ID: demo-natural-highs
  VITE_STORAGE_BUCKET: demo-natural-highs.appspot.com
  VITE_MESSAGING_SENDER_ID: "000000000000"
  VITE_APP_ID: demo-app-id
  VITE_USE_EMULATORS: "true"

jobs:
  # ============================================
  # Stage 1: Code Quality (Trunk.io)
  # ============================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Trunk
        uses: actions/cache@v4
        with:
          path: ~/.cache/trunk
          key: trunk-${{ runner.os }}-${{ hashFiles('.trunk/trunk.yaml') }}
          restore-keys: |
            trunk-${{ runner.os }}-

      - name: Trunk Check
        uses: trunk-io/trunk-action@v1

  # ============================================
  # Stage 2: Unit Tests
  # ============================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests with coverage
        run: bun run test:ci -- --coverage

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./.build/test-results/junit.xml
          flags: unittests
          slug: Natural-Highs/live
          verbose: true
          codecov_yml_path: ./.github/codecov.yml
          report_type: test_results

      - name: Coverage Threshold Check
        run: |
          if [ -f .build/coverage/coverage-summary.json ]; then
            LINES=$(cat .build/coverage/coverage-summary.json | jq -r '.total.lines.pct')
            BRANCHES=$(cat .build/coverage/coverage-summary.json | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat .build/coverage/coverage-summary.json | jq -r '.total.functions.pct')
            STATEMENTS=$(cat .build/coverage/coverage-summary.json | jq -r '.total.statements.pct')

            echo "Line coverage: ${LINES}%"
            echo "Branch coverage: ${BRANCHES}%"
            echo "Function coverage: ${FUNCTIONS}%"
            echo "Statement coverage: ${STATEMENTS}%"

            FAILED=0

            # Threshold check (70% for all metrics - matches vitest.config.ts)
            # Using awk for portable float comparison
            if awk "BEGIN {exit !($LINES < 70)}"; then
              echo "::error::Line coverage ${LINES}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($BRANCHES < 70)}"; then
              echo "::error::Branch coverage ${BRANCHES}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($FUNCTIONS < 70)}"; then
              echo "::error::Function coverage ${FUNCTIONS}% is below 70% threshold"
              FAILED=1
            fi

            if awk "BEGIN {exit !($STATEMENTS < 70)}"; then
              echo "::error::Statement coverage ${STATEMENTS}% is below 70% threshold"
              FAILED=1
            fi

            if [ $FAILED -eq 1 ]; then
              exit 1
            fi

            echo "::notice::Coverage thresholds passed (70% for all metrics)"
          else
            echo "::warning::Coverage report not found"
          fi

      - name: Coverage Summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f .build/coverage/coverage-summary.json ]; then
            cat .build/coverage/coverage-summary.json | jq -r '.total | "- Lines: \(.lines.pct)% (threshold: 70%)\n- Branches: \(.branches.pct)% (threshold: 70%)\n- Functions: \(.functions.pct)% (threshold: 70%)\n- Statements: \(.statements.pct)% (threshold: 70%)"' >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./.build/coverage/lcov.info
          flags: unittests
          slug: Natural-Highs/live
          name: unit-tests-${{ github.run_id }}
          fail_ci_if_error: false
          verbose: true
          codecov_yml_path: ./.github/codecov.yml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: .build/coverage/
          retention-days: 7

  # ============================================
  # Stage 3a: Smoke E2E Tests (PRs only - fast feedback)
  # ============================================
  test-e2e-smoke:
    name: Smoke E2E
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Java (for Firebase emulators)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Cache Firebase emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps

      - name: Install Playwright system deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Auth emulator ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Run Smoke E2E tests
        run: bunx playwright test --grep @smoke
        env:
          CI: true

      - name: Upload to Trunk Flaky Detection
        if: ${{ !cancelled() }}
        continue-on-error: true
        uses: trunk-io/analytics-uploader@v1
        with:
          junit-paths: .build/e2e-results/junit.xml
          org-slug: natural-highs
          token: ${{ secrets.TRUNK_API_TOKEN }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-smoke
          path: .build/playwright-report/
          retention-days: 30

  # ============================================
  # Stage 3b: Full E2E Tests (main only - gates deploy)
  # ============================================
  test-e2e-full:
    name: E2E Tests (Shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Java (for Firebase emulators)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Cache Firebase emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps

      - name: Install Playwright system deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only auth,firestore --project demo-natural-highs &
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "Auth emulator ready"
              break
            fi
            echo "Waiting for emulators... ($i/30)"
            sleep 1
          done
          sleep 2

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: bun run test:e2e:ci -- --shard=${{ matrix.shard }}/4
        env:
          CI: true

      - name: Upload to Trunk Flaky Detection
        if: ${{ !cancelled() }}
        continue-on-error: true
        uses: trunk-io/analytics-uploader@v1
        with:
          junit-paths: .build/e2e-results/junit.xml
          org-slug: natural-highs
          token: ${{ secrets.TRUNK_API_TOKEN }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: .build/playwright-report/
          retention-days: 30

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-shard-${{ matrix.shard }}
          path: .build/test-results/
          retention-days: 30

  # ============================================
  # Stage 3c: Deploy E2E Test Report
  # ============================================
  deploy-test-report:
    name: Deploy Test Report
    runs-on: ubuntu-latest
    needs: [test-e2e-full]
    # Only deploy on main branch OR when tests fail (to debug failures)
    if: |
      always() && 
      needs.test-e2e-full.result != 'cancelled' &&
      github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Download all Playwright reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-shard-*
          path: all-reports
          merge-multiple: true

      - name: Merge reports
        run: |
          # Install playwright to use merge-reports
          npm install -g playwright
          # Merge all shard reports into one
          npx playwright merge-reports --reporter=html all-reports -o merged-report || {
            echo "Merge failed, using raw reports"
            mkdir -p merged-report
            cp -r all-reports/* merged-report/ 2>/dev/null || true
          }

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: merged-report
          production-deploy: ${{ github.ref == 'refs/heads/main' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "E2E Report - ${{ github.event.pull_request.title || github.sha }}"
          alias: ${{ github.event.pull_request.number && format('pr-{0}', github.event.pull_request.number) || '' }}
          enable-pull-request-comment: true
          enable-commit-comment: false
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: 033f172d-782e-430f-a338-b9dec48fff80
        timeout-minutes: 5

      - name: Add report link to summary
        run: |
          echo "## E2E Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the full test report with traces and screenshots:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[${{ steps.netlify.outputs.deploy-url }}](${{ steps.netlify.outputs.deploy-url }})" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 4: Deploy to Netlify (main only, after E2E passes)
  # ============================================
  deploy:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: [test-e2e-full]
    if: github.ref == 'refs/heads/main' && needs.test-e2e-full.result == 'success'
    steps:
      - name: Trigger Netlify Deploy
        env:
          NETLIFY_BUILD_HOOK: ${{ secrets.NETLIFY_BUILD_HOOK }}
        run: |
          if [ -z "$NETLIFY_BUILD_HOOK" ]; then
            echo "::warning::NETLIFY_BUILD_HOOK secret not configured. Skipping deploy."
            exit 0
          fi
          # Use -f to fail on HTTP errors, --retry for transient failures
          curl -f --retry 3 --retry-delay 5 -X POST "$NETLIFY_BUILD_HOOK"

  # ============================================
  # Stage 5: Deploy Firestore Rules (main only)
  # ============================================
  deploy-firestore-rules:
    name: Deploy Firestore Rules
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-e2e-full]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: prd
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy Firestore Rules
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/sa.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.json

          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if firebase deploy --only firestore:rules --project naturalhighs; then
              echo "Deployment successful"
              break
            fi
            if [ $attempt -eq $max_attempts ]; then
              echo "All attempts failed"
              rm /tmp/sa.json
              exit 1
            fi
            echo "Attempt $attempt failed, retrying in $((attempt * 10)) seconds..."
            sleep $((attempt * 10))
            attempt=$((attempt + 1))
          done

          rm /tmp/sa.json
