name: Sync Secrets

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-doppler-to-gcp:
    name: Sync Doppler to GCP Secret Manager
    runs-on: ubuntu-latest
    environment: prd
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Sync secrets to GCP Secret Manager
        env:
          PROJECT_ID: naturalhighs
          VITE_APIKEY: ${{ secrets.VITE_APIKEY }}
          VITE_AUTH_DOMAIN: ${{ secrets.VITE_AUTH_DOMAIN }}
          VITE_PROJECT_ID: ${{ secrets.VITE_PROJECT_ID }}
          VITE_STORAGE_BUCKET: ${{ secrets.VITE_STORAGE_BUCKET }}
          VITE_MESSAGING_SENDER_ID: ${{ secrets.VITE_MESSAGING_SENDER_ID }}
          VITE_APP_ID: ${{ secrets.VITE_APP_ID }}
        run: |
          # List of secrets to sync
          SECRETS="VITE_APIKEY VITE_AUTH_DOMAIN VITE_PROJECT_ID VITE_STORAGE_BUCKET VITE_MESSAGING_SENDER_ID VITE_APP_ID"

          # Service accounts that need access
          COMPUTE_SA="firebase-app-hosting-compute@${PROJECT_ID}.iam.gserviceaccount.com"
          PROJECT_NUMBER=$(gcloud projects describe "$PROJECT_ID" --format='value(projectNumber)')
          SERVICE_AGENT="service-${PROJECT_NUMBER}@gcp-sa-firebaseapphosting.iam.gserviceaccount.com"

          for SECRET_NAME in $SECRETS; do
            # Get value from environment variable
            SECRET_VALUE="${!SECRET_NAME}"

            if [ -z "$SECRET_VALUE" ]; then
              echo "Warning: $SECRET_NAME is empty, skipping..."
              continue
            fi

            echo -n "Syncing $SECRET_NAME... "

            # Check if secret exists
            if gcloud secrets describe "$SECRET_NAME" --project="$PROJECT_ID" &>/dev/null; then
              # Update existing secret
              echo -n "$SECRET_VALUE" | gcloud secrets versions add "$SECRET_NAME" \
                --project="$PROJECT_ID" \
                --data-file=- \
                --quiet
              echo "updated"
            else
              # Create new secret
              echo -n "$SECRET_VALUE" | gcloud secrets create "$SECRET_NAME" \
                --project="$PROJECT_ID" \
                --data-file=- \
                --replication-policy="automatic" \
                --quiet
              echo "created"
            fi

            # Always ensure Firebase App Hosting service accounts have access
            # (idempotent - safe to run even if binding exists)
            gcloud secrets add-iam-policy-binding "$SECRET_NAME" \
              --project="$PROJECT_ID" \
              --member="serviceAccount:$COMPUTE_SA" \
              --role="roles/secretmanager.secretAccessor" \
              --quiet > /dev/null 2>&1 || true

            gcloud secrets add-iam-policy-binding "$SECRET_NAME" \
              --project="$PROJECT_ID" \
              --member="serviceAccount:$SERVICE_AGENT" \
              --role="roles/secretmanager.secretAccessor" \
              --quiet > /dev/null 2>&1 || true
          done

          echo ""
          echo "Secrets synced. Firebase App Hosting will pick them up on next build."
